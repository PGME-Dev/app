<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; margin: 0; padding: 20px; background: #f5f5f5; text-align: center; }
    #info { margin-top: 20px; }
    #status { margin-top: 40px; font-size: 16px; color: #666; }
    .error { color: #d32f2f; background: #ffebee; padding: 16px; border-radius: 8px; margin: 20px; text-align: left; }
    h2 { color: #333; }
  </style>
</head>
<body>
  <div id="info"></div>
  <div id="status">Waiting for payment config...</div>

  <script src="https://static.zohocdn.com/zpay/zpay-js/v1/zpayments.js"></script>
  <script>
    console.log('=== ZOHO PAYMENT PAGE LOADED ===');
    console.log('Origin: ' + window.location.origin);
    console.log('URL: ' + window.location.href);
    console.log('Zoho SDK loaded: ' + (typeof ZPayments !== 'undefined'));

    var statusEl = document.getElementById('status');
    var infoEl = document.getElementById('info');

    // This function is called from Flutter via runJavaScript
    function startPayment(config) {
      console.log('startPayment called with config:');
      console.log('  account_id: ' + config.account_id);
      console.log('  session_id: ' + config.session_id);
      console.log('  amount: ' + config.amount + ' ' + config.currency);

      infoEl.innerHTML = '<h2>' + config.currency + ' ' + config.amount + '</h2>';
      statusEl.textContent = 'Loading payment gateway...';

      if (typeof ZPayments === 'undefined') {
        console.error('ZPayments SDK not available');
        statusEl.innerHTML = '<div class="error">Payment gateway failed to load. Please check your internet connection and try again.</div>';
        sendToFlutter({ status: 'failed', error_message: 'Zoho SDK not loaded' });
        return;
      }

      statusEl.textContent = 'Initializing payment...';

      try {
        var zpay = new ZPayments({
          account_id: config.account_id,
          domain: 'IN',
          otherOptions: { api_key: config.api_key }
        });
        console.log('ZPayments instance created');

        statusEl.textContent = 'Opening payment form...';

        zpay.requestPaymentMethod({
          payments_session_id: config.session_id,
          amount: String(config.amount),
          currency_code: config.currency,
          transaction_type: 'payment'
        }).then(function(response) {
          console.log('Payment response: ' + JSON.stringify(response));

          if (response && response.status === 'success') {
            statusEl.textContent = 'Payment successful! Verifying...';
            sendToFlutter({
              status: 'success',
              payment_id: response.payment_id || '',
              payment_session_id: response.payment_session_id || config.session_id,
              signature: response.signature || null
            });
          } else if (response && response.status === 'failed') {
            statusEl.innerHTML = '<div class="error">Payment failed: ' + (response.error_message || 'Unknown error') + '</div>';
            sendToFlutter({ status: 'failed', error_message: response.error_message || 'Payment failed' });
          } else if (response && response.status === 'cancelled') {
            statusEl.textContent = 'Payment cancelled';
            sendToFlutter({ status: 'cancelled' });
          } else {
            console.log('Unexpected response: ' + JSON.stringify(response));
            sendToFlutter({ status: 'failed', error_message: 'Unexpected response from payment gateway' });
          }
        }).catch(function(err) {
          console.error('Payment error: ' + err.message);
          statusEl.innerHTML = '<div class="error">Error: ' + err.message + '</div>';
          sendToFlutter({ status: 'failed', error_message: err.message });
        });
      } catch(err) {
        console.error('Init error: ' + err.message);
        statusEl.innerHTML = '<div class="error">Error: ' + err.message + '</div>';
        sendToFlutter({ status: 'failed', error_message: err.message });
      }
    }

    function sendToFlutter(data) {
      console.log('Sending to Flutter: ' + JSON.stringify(data));
      try {
        FlutterPayment.postMessage(JSON.stringify(data));
      } catch(e) {
        console.error('Failed to send to Flutter: ' + e);
      }
    }
  </script>
</body>
</html>
